

library(tidyverse)

# charge database
hny <- openxlsx::read.xlsx("Honeycreepers_28_03_24.xlsx")

hny <- hny %>% mutate(u = "status") %>%
  mutate(Rlcate = ifelse(is.na(IUCN.status), "EX",IUCN.status)) %>%
  mutate(Rlcatef = factor(Rlcate, levels = c("LC","NT","VU","EN","CR","EX"), ordered = T))
# %>% select(Combined.list, Rlcatef, u) %>% distinct()
hny_c <- hny %>% group_by(Rlcatef) %>% count() %>%
  mutate(prop = n/ nrow(hny))
hny_c$prop_cum = 1-cumsum(hny_c$prop)+(hny_c$prop)/2

hny_all <- left_join(hny, hny_c)

stat_p <- ggplot(hny_all)+
  geom_bar(aes(x = u, fill = Rlcatef), position = "fill", width = .5)+
  scale_fill_manual(values = c("LC"="mediumseagreen", "NT"="olivedrab2", 
                               "VU"="gold2", "EN"="darkorange2", "CR"="firebrick2",
                               "EX" = "black"))+
  geom_text(aes(x = u, y = prop_cum, label = n), colour = "white")+
  # geom_text(aes(x = u, y = prop_cum, label = Rlcatef), colour = "black", 
  #           position = position_dodge(width = 1),
  #           vjust = -5)+
  xlab("")+ylab("Proportion of species")+
  theme_classic()+
  coord_flip()
stat_p

threat <- hny %>% filter(EX_noEX=="noEX")%>%
  select(Combined.list, Agriculture.and.aquaculture:Human.intrusions.and.disturbance)%>%
  mutate(
    IAS = if_else(is.na(`Invasive.and.other.problematic.species,.genes.and.diseases`),0,1),
    Po = 0,
    OE = if_else(is.na(Biological.resource.use), 0,1),
    CC = if_else(is.na(Climate.change.and.severe.weather), 0,1),
    HL = if_else(is.na(Agriculture.and.aquaculture) &
                   is.na(Transporation.and.service.corridors) &
                   is.na(Human.intrusions.and.disturbance) &
                   is.na(Natural.systems.modifications) &
                   is.na(Residential.and.commercial.development), 0,1)
  ) %>%
  pivot_longer(cols = IAS:HL,
               names_to = "Threat", values_to = "is_threat") %>%
  mutate_if(is.numeric, as.factor) %>%
  mutate(Threat = factor(Threat, levels = c("Po","OE","CC","HL","IAS"), ordered =T))


threat_p <- ggplot(threat)+
  geom_bar(aes(x = Threat, fill = is_threat), position = "fill", width = .4)+
  scale_fill_manual(values = c("0"="gray90", "1"="grey8"))+
  theme_classic()+
  coord_flip()
threat_p

pdf("Z:/RIVAGE/02_Papers/opinion_paper_1/Fig_box_HC1_all.pdf", 5, 2)
stat_p
dev.off()

pdf("Z:/RIVAGE/02_Papers/opinion_paper_1/Fig_box_HC2_all.pdf", 5, 2)
threat_p
dev.off()



